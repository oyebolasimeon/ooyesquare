<div class="page-background">
  <div class="page-content">
    <div class="container">
      <!-- Header -->
      <div class="header-section">
        <button pButton icon="pi pi-arrow-left" (click)="goBack()" class="p-button-text" label="Back"></button>
        <h1>{{ category }} Elections{{ state ? ' - ' + state : '' }}</h1>
        <p class="subtitle">Vote for your preferred candidates</p>
      </div>

      <!-- Loading -->
      <div *ngIf="loading" class="loading-spinner">
        <i class="pi pi-spin pi-spinner" style="font-size: 3rem; color: #4F46E5;"></i>
      </div>

      <!-- Positions List -->
      <div *ngIf="!loading" class="positions-list">
        <p-card *ngFor="let position of positions" class="position-card">
          <div class="position-header" (click)="togglePosition(position._id!)">
            <div class="position-info">
              <h3>{{ position.name || position.title }}</h3>
              <p *ngIf="position.description">{{ position.description }}</p>
            </div>
            <div class="position-status">
              <span *ngIf="selectedVotes[position._id!] === undefined" class="status-badge pending">
                <i class="pi pi-clock"></i> Not Voted
              </span>
              <span *ngIf="selectedVotes[position._id!] === null" class="status-badge skipped">
                <i class="pi pi-minus-circle"></i> Skipped
              </span>
              <span *ngIf="selectedVotes[position._id!] && selectedVotes[position._id!] !== null" class="status-badge voted">
                <i class="pi pi-check-circle"></i> Voted
              </span>
              <i class="pi" [ngClass]="expandedPositions[position._id!] ? 'pi-chevron-up' : 'pi-chevron-down'"></i>
            </div>
          </div>

          <!-- Contestants -->
          <div *ngIf="expandedPositions[position._id!]" class="contestants-section">
            <div class="contestants-grid">
              <div 
                *ngFor="let contestant of contestants[position._id!]"
                class="contestant-card"
                [ngClass]="{'selected': selectedVotes[position._id!] === contestant._id}"
                (click)="selectContestant(position._id!, contestant._id!)">
                <div class="contestant-avatar">
                  <p-avatar 
                    [label]="(contestant.firstName || contestant.name || 'C').charAt(0) + (contestant.lastName || 'N').charAt(0)" 
                    size="xlarge" 
                    shape="circle"
                    [style]="{'background-color': selectedVotes[position._id!] === contestant._id ? '#4F46E5' : '#9CA3AF', 'color': '#ffffff'}">
                  </p-avatar>
                  <div *ngIf="selectedVotes[position._id!] === contestant._id" class="check-icon">
                    <i class="pi pi-check"></i>
                  </div>
                </div>
                <div class="contestant-info">
                  <h4>{{ contestant.name || (contestant.firstName + ' ' + (contestant.maidenName ? contestant.maidenName + ' ' : '') + contestant.lastName) }}</h4>
                  <p *ngIf="contestant.bio">{{ contestant.bio }}</p>
                </div>
                <p-radioButton 
                  [name]="'position_' + position._id!" 
                  [value]="contestant._id!"
                  [(ngModel)]="selectedVotes[position._id!]">
                </p-radioButton>
              </div>
            </div>

            <div class="skip-section">
              <button 
                pButton 
                label="Skip this position" 
                icon="pi pi-forward"
                class="p-button-text p-button-secondary"
                (click)="skipPosition(position._id!)">
              </button>
            </div>
          </div>
        </p-card>
      </div>

      <!-- Submit Button -->
      <div *ngIf="!loading && positions.length > 0" class="submit-section">
        <p-card>
          <div class="submit-summary">
            <div>
              <h3>Review Your Votes</h3>
              <p>{{ Object.keys(selectedVotes).length }} of {{ positions.length }} positions selected</p>
            </div>
            <button 
              pButton 
              label="Submit Votes" 
              icon="pi pi-send"
              class="p-button-lg p-button-success"
              [disabled]="submitting"
              (click)="submitVotes()">
            </button>
          </div>
        </p-card>
      </div>
    </div>
  </div>
</div>

<!-- Empty Votes Warning Modal -->
<p-dialog 
  header="Incomplete Voting" 
  [(visible)]="showEmptyWarning" 
  [modal]="true"
  [closable]="false"
  [style]="{width: '500px'}">
  <div class="modal-content">
    <div class="warning-icon">
      <i class="pi pi-exclamation-triangle" style="font-size: 3rem; color: #F59E0B;"></i>
    </div>
    <p class="modal-message">
      You have not voted for {{ emptyPositions.length }} position(s):
    </p>
    <ul class="empty-positions-list">
      <li *ngFor="let pos of emptyPositions">{{ pos.name || pos.title }}</li>
    </ul>
    <p>Are you sure you want to continue without voting for these positions?</p>
  </div>
  <ng-template pTemplate="footer">
    <button 
      pButton 
      label="Go Back" 
      icon="pi pi-arrow-left"
      class="p-button-text"
      (click)="showEmptyWarning = false">
    </button>
    <button 
      pButton 
      label="Continue" 
      icon="pi pi-arrow-right"
      (click)="proceedWithEmpty()">
    </button>
  </ng-template>
</p-dialog>

<!-- Final Confirmation Modal -->
<p-dialog 
  header="Confirm Submission" 
  [(visible)]="showFinalConfirmation" 
  [modal]="true"
  [closable]="!submitting"
  [style]="{width: '500px'}">
  <div class="modal-content">
    <div class="confirm-icon">
      <i class="pi pi-question-circle" style="font-size: 3rem; color: #4F46E5;"></i>
    </div>
    <p class="modal-message">
      You are about to submit your votes. This action cannot be undone.
    </p>
    <p><strong>Are you sure you want to proceed?</strong></p>
  </div>
  <ng-template pTemplate="footer">
    <button 
      pButton 
      label="Cancel" 
      icon="pi pi-times"
      class="p-button-text"
      [disabled]="submitting"
      (click)="showFinalConfirmation = false">
    </button>
    <button 
      pButton 
      label="Submit Votes" 
      icon="pi pi-check"
      class="p-button-success"
      [disabled]="submitting"
      [loading]="submitting"
      (click)="finalSubmit()">
    </button>
  </ng-template>
</p-dialog>

