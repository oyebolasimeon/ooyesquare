<div class="admin-layout">
  <app-admin-sidebar #sidebar [activeRoute]="'results'"></app-admin-sidebar>
  
  <div class="main-content">
    <app-admin-topbar [title]="'Election Results & Analytics'" [icon]="'pi-chart-bar'" (toggleMenu)="sidebar.toggleMobileMenu()"></app-admin-topbar>
    
    <div class="content-area">
      <div class="results-container">
        <!-- Export Button -->
        <div class="toolbar">
          <button pButton label="Export Results" icon="pi pi-download" (click)="exportResults()" 
                  [loading]="exporting" class="export-btn"></button>
        </div>

        <p-tabView (onChange)="onTabChange($event)">
          <!-- National Results Tab -->
          <p-tabPanel header="National Elections" leftIcon="pi pi-flag">
            <div class="results-content" *ngIf="!loading && nationalResults.length > 0">
              <div class="position-result" *ngFor="let result of nationalResults">
                <p-card>
                  <ng-template pTemplate="header">
                    <div class="result-header">
                      <h3>{{ getPositionName(result) }}</h3>
                      <div class="header-stats">
                        <p-tag icon="pi pi-check-circle" [value]="result.totalVotes + ' Total Votes'" severity="info"></p-tag>
                      </div>
                    </div>
                  </ng-template>

                  <div class="result-content">
                    <!-- Tie Announcement -->
                    <div class="tie-box" *ngIf="result.isTie">
                      <div class="tie-icon">
                        <i class="pi pi-users"></i>
                      </div>
                      <div class="tie-info">
                        <h4>TIE</h4>
                        <p class="tie-description">Multiple contestants tied with the highest votes</p>
                        <div class="tied-contestants">
                          <div class="tied-contestant" *ngFor="let contestant of result.tiedContestants">
                            <i class="pi pi-user"></i>
                            <span>{{ contestant.firstName }} {{ contestant.lastName }}</span>
                            <strong>{{ contestant.voteCount }} votes</strong>
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- Winner Announcement -->
                    <div class="winner-box" *ngIf="result.winner && !result.isTie">
                      <div class="winner-icon">
                        <i class="pi pi-trophy"></i>
                      </div>
                      <div class="winner-info">
                        <h4>Winner</h4>
                        <p class="winner-name">{{ result.winner.contestant.firstName }} {{ result.winner.contestant.lastName }}</p>
                        <p class="winner-votes">
                          {{ result.winner.voteCount }} votes 
                          ({{ getVotePercentage(result.winner.voteCount, result.totalVotes) }}%)
                        </p>
                      </div>
                    </div>

                    <!-- Results Table -->
                    <div class="results-table">
                      <p-table [value]="result.results" styleClass="p-datatable-sm">
                        <ng-template pTemplate="header">
                          <tr>
                            <th>Rank</th>
                            <th>Contestant</th>
                            <th>Votes</th>
                            <th>Percentage</th>
                          </tr>
                        </ng-template>
                        <ng-template pTemplate="body" let-item let-i="rowIndex">
                          <tr>
                            <td>{{ i + 1 }}</td>
                            <td>
                              <span [class.winner-row]="i === 0">{{ item.contestant.firstName }} {{ item.contestant.lastName }}</span>
                            </td>
                            <td>{{ item.voteCount }}</td>
                            <td>
                              <div class="percentage-bar">
                                <div class="bar" [style.width]="getVotePercentage(item.voteCount, result.totalVotes) + '%'"></div>
                                <span class="percentage-text">{{ getVotePercentage(item.voteCount, result.totalVotes) }}%</span>
                              </div>
                            </td>
                          </tr>
                        </ng-template>
                      </p-table>
                    </div>

                    <!-- Chart -->
                    <div class="chart-container">
                      <h4>Vote Distribution</h4>
                      <p-chart type="bar" [data]="getChartData(result)" [options]="getChartOptions()"></p-chart>
                    </div>
                  </div>
                </p-card>
              </div>
            </div>

            <div class="empty-state" *ngIf="!loading && nationalResults.length === 0">
              <i class="pi pi-inbox" style="font-size: 3rem; color: #94A3B8;"></i>
              <p>No national election results available yet.</p>
            </div>
          </p-tabPanel>

          <!-- State Results Tab -->
          <p-tabPanel header="State Elections" leftIcon="pi pi-map">
            <div class="results-content" *ngIf="!loading && stateResults.length > 0">
              <div class="position-result" *ngFor="let result of stateResults">
                <p-card>
                  <ng-template pTemplate="header">
                    <div class="result-header">
                      <h3>{{ getPositionName(result) }}</h3>
                    <div class="header-stats">
                      <p-tag icon="pi pi-check-circle" [value]="result.totalVotes + ' Total Votes'" severity="warn"></p-tag>
                    </div>
                    </div>
                  </ng-template>

                  <div class="result-content">
                    <!-- Tie Announcement -->
                    <div class="tie-box" *ngIf="result.isTie">
                      <div class="tie-icon">
                        <i class="pi pi-users"></i>
                      </div>
                      <div class="tie-info">
                        <h4>TIE</h4>
                        <p class="tie-description">Multiple contestants tied with the highest votes</p>
                        <div class="tied-contestants">
                          <div class="tied-contestant" *ngFor="let contestant of result.tiedContestants">
                            <i class="pi pi-user"></i>
                            <span>{{ contestant.firstName }} {{ contestant.lastName }}</span>
                            <strong>{{ contestant.voteCount }} votes</strong>
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- Winner Announcement -->
                    <div class="winner-box" *ngIf="result.winner && !result.isTie">
                      <div class="winner-icon">
                        <i class="pi pi-trophy"></i>
                      </div>
                      <div class="winner-info">
                        <h4>Winner</h4>
                        <p class="winner-name">{{ result.winner.contestant.firstName }} {{ result.winner.contestant.lastName }}</p>
                        <p class="winner-votes">
                          {{ result.winner.voteCount }} votes 
                          ({{ getVotePercentage(result.winner.voteCount, result.totalVotes) }}%)
                        </p>
                      </div>
                    </div>

                    <!-- Results Table -->
                    <div class="results-table">
                      <p-table [value]="result.results" styleClass="p-datatable-sm">
                        <ng-template pTemplate="header">
                          <tr>
                            <th>Rank</th>
                            <th>Contestant</th>
                            <th>Votes</th>
                            <th>Percentage</th>
                          </tr>
                        </ng-template>
                        <ng-template pTemplate="body" let-item let-i="rowIndex">
                          <tr>
                            <td>{{ i + 1 }}</td>
                            <td>
                              <span [class.winner-row]="i === 0">{{ item.contestant.firstName }} {{ item.contestant.lastName }}</span>
                            </td>
                            <td>{{ item.voteCount }}</td>
                            <td>
                              <div class="percentage-bar">
                                <div class="bar" [style.width]="getVotePercentage(item.voteCount, result.totalVotes) + '%'"></div>
                                <span class="percentage-text">{{ getVotePercentage(item.voteCount, result.totalVotes) }}%</span>
                              </div>
                            </td>
                          </tr>
                        </ng-template>
                      </p-table>
                    </div>

                    <!-- Chart -->
                    <div class="chart-container">
                      <h4>Vote Distribution</h4>
                      <p-chart type="bar" [data]="getChartData(result)" [options]="getChartOptions()"></p-chart>
                    </div>
                  </div>
                </p-card>
              </div>
            </div>

            <div class="empty-state" *ngIf="!loading && stateResults.length === 0">
              <i class="pi pi-inbox" style="font-size: 3rem; color: #94A3B8;"></i>
              <p>No state election results available yet.</p>
            </div>
          </p-tabPanel>
        </p-tabView>
      </div>
    </div>
  </div>

  <!-- Toast Messages -->
  <p-toast></p-toast>
</div>
